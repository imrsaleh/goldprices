<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>سعر الذهب الآن</title>
  <script src="https://www.livepriceofgold.com/live/socket.io.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: #333;
      line-height: 1.6;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      padding: 30px;
      position: relative;
      overflow: hidden;
    }
    
    .container::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(90deg, #ffd700, #daa520, #b8860b);
    }
    
    header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #eee;
    }
    
    h1 {
      color: #2c3e50;
      font-size: 2.2rem;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #7f8c8d;
      font-size: 1rem;
    }
    
    .currency-selector {
      margin: 25px 0;
      text-align: center;
    }
    
    .currency-selector label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: #2c3e50;
    }
    
    select {
      width: 100%;
      max-width: 300px;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      background-color: #f9f9f9;
      font-size: 1rem;
      color: #333;
      outline: none;
      transition: all 0.3s;
    }
    
    select:focus {
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    
    .gold-prices {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 20px;
      margin-top: 30px;
    }
    
    .gold-type {
      flex: 1;
      min-width: 200px;
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      text-align: center;
      transition: transform 0.3s;
      border: 1px solid #f0f0f0;
    }
    
    .gold-type:hover {
      transform: translateY(-5px);
    }
    
    .gold-type h3 {
      color: #2c3e50;
      margin-bottom: 15px;
      font-size: 1.3rem;
    }
    
    .price {
      font-size: 1.8rem;
      font-weight: bold;
      color: #27ae60;
      margin: 10px 0;
    }
    
    .price-details {
      margin-top: 15px;
      font-size: 0.9rem;
      color: #7f8c8d;
    }
    
    .price-details div {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
    }
    
    .bid {
      color: #e74c3c;
    }
    
    .ask {
      color: #3498db;
    }
    
    .last-update {
      text-align: center;
      margin-top: 30px;
      color: #95a5a6;
      font-size: 0.9rem;
    }
    
    .loader {
      text-align: center;
      padding: 20px;
      color: #7f8c8d;
    }
    
    .error {
      text-align: center;
      padding: 20px;
      color: #e74c3c;
      background-color: #fadbd8;
      border-radius: 8px;
      margin: 20px 0;
    }
    
    .warning {
      text-align: center;
      padding: 15px;
      color: #f39c12;
      background-color: #fef5e7;
      border-radius: 8px;
      margin: 20px 0;
      border-right: 4px solid #f39c12;
    }
    
    .info {
      text-align: center;
      padding: 15px;
      color: #3498db;
      background-color: #ebf5fb;
      border-radius: 8px;
      margin: 20px 0;
      border-right: 4px solid #3498db;
    }
    
    .connection-status {
      position: fixed;
      bottom: 20px;
      left: 20px;
      padding: 10px 15px;
      border-radius: 20px;
      font-size: 0.8rem;
      color: white;
      z-index: 100;
    }
    
    .connected {
      background-color: #2ecc71;
    }
    
    .disconnected {
      background-color: #e74c3c;
    }
    
    .fallback {
      background-color: #f39c12;
    }
    
    .initial {
      background-color: #3498db;
    }
    
    @media (max-width: 768px) {
      .gold-prices {
        flex-direction: column;
      }
      
      .container {
        padding: 20px;
      }
      
      h1 {
        font-size: 1.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>🔴مباشر اسعار الذهب</h1>
      <p class="subtitle">أسعار الذهب المحدثة لحظياً بالعملات المختلفة</p>
    </header>
    
    <div class="currency-selector">
      <label for="currency-select">اختر العملة:</label>
      <select id="currency-select">
        <option value="">جارٍ تحميل العملات...</option>
      </select>
    </div>

    
    
    <div class="gold-prices">
      <div class="gold-type">
        <h3>ذهب عيار 24</h3>
        <div class="price" id="24K-price">--</div>
        <div class="price-details">
          <div>السعر الأساسي: <span id="24K-base">--</span></div>
          <div class="bid">سعر البيع: <span id="24K-bid">--</span></div>
          <div class="ask">سعر الشراء: <span id="24K-ask">--</span></div>
        </div>
      </div>
      
      <div class="gold-type">
        <h3>ذهب عيار 22</h3>
        <div class="price" id="22K-price">--</div>
        <div class="price-details">
          <div>السعر الأساسي: <span id="22K-base">--</span></div>
          <div class="bid">سعر البيع: <span id="22K-bid">--</span></div>
          <div class="ask">سعر الشراء: <span id="22K-ask">--</span></div>
        </div>
      </div>
      
      <div class="gold-type">
        <h3>ذهب عيار 21</h3>
        <div class="price" id="21K-price">--</div>
        <div class="price-details">
          <div>السعر الأساسي: <span id="21K-base">--</span></div>
          <div class="bid">سعر البيع: <span id="21K-bid">--</span></div>
          <div class="ask">سعر الشراء: <span id="21K-ask">--</span></div>
        </div>
      </div>
    </div>
    
    <div class="last-update">
      آخر تحديث: <span id="last-update-time">--</span>
    </div>
  </div>
  
  <div class="connection-status initial" id="connection-status">
    جارٍ التحميل...
  </div>

  <script>
    // بيانات العملات
    const currency_code = [
        {"Country":"أمريكا","sub_name": "دولار امريكي","code": "usd"},
        {"Country":"السعودية","sub_name": "ريال سعودي","code": "sar",},
        {"Country":"الإمارات","sub_name": "درهم اماراتي","code": "aed"},
        {"Country":"مصر","sub_name": "جنيه مصري","code": "egp"},
        {"Country":"قطر","sub_name": "ريال قطري","code": "qar"},
        {"Country":"الاتحاد الاوروبي","sub_name": "يورو","code": "eur"},
        {"Country":"الاردن","sub_name": "دينار اردني","code": "jod"},
        {"Country":"البحرين","sub_name": "دينار بحريني","code": "bhd"},
        {"Country":"الجزائر","sub_name": "دينار جزائرى","code": "dzd"},
        {"Country":"سوريا","sub_name": "جنيه سوري","code": "syp"},
        {"Country":"السودان","sub_name": "جنيه سوداني","code": "sdg"},
        {"Country":"العراق","sub_name": "دينار عراقي","code": "iqd"},
        {"Country":"الكويت","sub_name": "دينار كويتي","code": "kwd"},
        {"Country":"المغرب","sub_name": "درهم مغربي","code": "mad"},
        {"Country":"بريطانيا","sub_name": "جنيه استرليني","code": "gbp"},
        {"Country":"الهند","sub_name": "الروبية الهندية","code": "inr"},
        {"Country":"اليمن","sub_name": "ريال يمني","code": "yer"},
        {"Country":"باكستان","sub_name": "الروبية باكستاني","code": "pkr"},
        {"Country":"تركيا","sub_name": "ليرة تركي","code": "try"},
        {"Country":"تونس","sub_name": "دينار تونسي","code": "tnd"},
        {"Country":"عمان","sub_name": "ريال عماني","code": "omr"},
        {"Country":"فلسطين","sub_name": "الشيكل","code": "ils"},
        {"Country":"لبنان","sub_name": "جنيه لبناني","code": "lbp"},
        {"Country":"ليبيا","sub_name": "دينار ليبي","code": "lyd"},
        {"Country":"موريتانيا","sub_name": "أوقية","code": "mru"}
    ];

    // المتغيرات العامة
    let exchangeRates = {};
    let selectedCurrency = "sar";
    let currentGoldPrices = {};
    let isUsingFallbackGoldData = true;
    let connectionTimeout;
    
    // السعر الاحتياطي للأونصة بالدولار
    const FALLBACK_USD_PER_OUNCE = 4018.21;
    const FALLBACK_UPDATE_DATE = "12/10/2025";

    // تهيئة الصفحة
    document.addEventListener('DOMContentLoaded', function() {
      initializeCurrencySelector();
      fetchExchangeRates();
    });

    // تهيئة قائمة اختيار العملة
    function initializeCurrencySelector() {
      const select = document.getElementById('currency-select');
      select.innerHTML = '';
      
      currency_code.forEach(currency => {
        const option = document.createElement('option');
        option.value = currency.code;
        option.textContent = `${currency.Country} - ${currency.sub_name}`;
        if (currency.code === selectedCurrency) {
          option.selected = true;
        }
        select.appendChild(option);
      });
      
      select.addEventListener('change', function() {
        selectedCurrency = this.value;
        if (currentGoldPrices.usdPerGram) {
          updateGoldPrices(currentGoldPrices.usdPerGram);
        }
      });
    }

    // جلب أسعار الصرف من API
    function fetchExchangeRates() {
      const REQcurrencyApi = new Request("https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/usd.json");
      
      fetch(REQcurrencyApi)
        .then(response => {
          if (!response.ok) {
            throw new Error('فشل في جلب بيانات أسعار الصرف');
          }
          return response.json();
        })
        .then(currencyApi => {
          exchangeRates = currencyApi.usd;
          document.getElementById('currency-select').disabled = false;
          console.log("تم جلب أسعار الصرف بنجاح");
          
          // بعد جلب أسعار الصرف، نعرض البيانات الاحتياطية للذهب
          initializeWithFallbackGoldData();
          
          // ثم نحاول الاتصال بخادم الذهب
          initializeSocketConnection();
        })
        .catch(error => {
          console.error("خطأ في جلب بيانات أسعار الصرف:", error);
          document.getElementById('currency-select').innerHTML = '<option value="">فشل تحميل العملات</option>';
          document.querySelector('.currency-selector').innerHTML += 
            '<div class="error">فشل في تحميل أسعار الصرف. يرجى تحديث الصفحة.</div>';
        });
    }

    // تهيئة البيانات الاحتياطية للذهب
    function initializeWithFallbackGoldData() {
      console.log('🔄 استخدام البيانات الاحتياطية للذهب');
      
      const usdPerGram = FALLBACK_USD_PER_OUNCE / 31.1034768;
      currentGoldPrices.usdPerGram = usdPerGram;
      
      updateGoldPrices(usdPerGram);
      updateLastUpdateTime(FALLBACK_UPDATE_DATE);
      
      updateConnectionStatus('initial');
    }

    // تهيئة اتصال WebSocket لأسعار الذهب الحية
    function initializeSocketConnection() {
      const socket = io('wss://socket.livepriceofgold.com:9011', {
        path: '/socket.io',
        transports: ['websocket'],
      });

      socket.on('connect', () => {
        console.log('✅ تم الاتصال بخادم أسعار الذهب');
        updateConnectionStatus(true);
        clearTimeout(connectionTimeout);
        isUsingFallbackGoldData = false;
      });

      socket.on('update', (message) => {
        try {
          const jsonData = JSON.parse(message);
          const usdPerOunce = jsonData["XAUUSD"];
          
          if (usdPerOunce) {
            const usdPerGram = usdPerOunce / 31.1034768;
            
            currentGoldPrices.usdPerGram = usdPerGram;
            updateGoldPrices(usdPerGram);
            updateLastUpdateTime();
            
            console.log('✅ تم تحديث أسعار الذهب من الخادم');
          }
          
        } catch (e) {
          console.error("خطأ في تحليل بيانات الذهب:", e);
          useFallbackGoldDataWithNotification();
        }
      });

      socket.on('disconnect', () => {
        console.warn('❌ تم قطع الاتصال بخادم أسعار الذهب');
        updateConnectionStatus(false);
        setTimeout(useFallbackGoldDataWithNotification, 2000);
      });

      socket.on('error', (error) => {
        console.error('خطأ في الاتصال بخادم الذهب:', error);
        updateConnectionStatus(false);
        useFallbackGoldDataWithNotification();
      });

      connectionTimeout = setTimeout(() => {}, 10000);
    }

    // استخدام البيانات الاحتياطية للذهب مع إشعار
    function useFallbackGoldDataWithNotification() {
      if (!isUsingFallbackGoldData) {
        console.log('🔄 استخدام البيانات الاحتياطية للذهب بعد فشل الاتصال');
        isUsingFallbackGoldData = true;
        
        const usdPerGram = FALLBACK_USD_PER_OUNCE / 31.1034768;
        currentGoldPrices.usdPerGram = usdPerGram;
        
        updateGoldPrices(usdPerGram);
        updateLastUpdateTime();
        
        updateConnectionStatus('fallback');
      }
    }

    // تحديث أسعار الذهب بناءً على العملة المختارة
    function updateGoldPrices(usdPerGram) {
      if (!exchangeRates[selectedCurrency]) {
        console.warn(`سعر الصرف غير متوفر للعملة: ${selectedCurrency}`);
        return;
      }
      
      const exchangeRate = exchangeRates[selectedCurrency];
      
      // حساب الأسعار للذهب عيار 24
      const PerGram24 = (usdPerGram * exchangeRate).toFixed(2);
      const PerGram24bid = (PerGram24 * 0.98).toFixed(2);
      const PerGram24ask = (PerGram24 * 1.05).toFixed(2);
      
      // حساب الأسعار للذهب عيار 22
      const PerGram22 = (PerGram24 * (22/24)).toFixed(2);
      const PerGram22bid = (PerGram22 * 0.98).toFixed(2);
      const PerGram22ask = (PerGram22 * 1.05).toFixed(2);
      
      // حساب الأسعار للذهب عيار 21
      const PerGram21 = (PerGram24 * (21/24)).toFixed(2);
      const PerGram21bid = (PerGram21 * 0.98).toFixed(2);
      const PerGram21ask = (PerGram21 * 1.05).toFixed(2);
      
      // تحديث واجهة المستخدم
      document.getElementById('24K-price').textContent = PerGram24;
      document.getElementById('24K-base').textContent = PerGram24;
      document.getElementById('24K-bid').textContent = PerGram24bid;
      document.getElementById('24K-ask').textContent = PerGram24ask;
      
      document.getElementById('22K-price').textContent = PerGram22;
      document.getElementById('22K-base').textContent = PerGram22;
      document.getElementById('22K-bid').textContent = PerGram22bid;
      document.getElementById('22K-ask').textContent = PerGram22ask;
      
      document.getElementById('21K-price').textContent = PerGram21;
      document.getElementById('21K-base').textContent = PerGram21;
      document.getElementById('21K-bid').textContent = PerGram21bid;
      document.getElementById('21K-ask').textContent = PerGram21ask;
    }

    // تحديث حالة الاتصال
    function updateConnectionStatus(status) {
      const statusElement = document.getElementById('connection-status');
      
      if (status === true) {
        statusElement.textContent = 'متصل - الأسعار محدثة لحظياً';
        statusElement.className = 'connection-status connected';
      } else if (status === 'fallback') {
        statusElement.textContent = 'غير متصل - عرض بيانات ذهب احتياطية';
        statusElement.className = 'connection-status fallback';
      } else if (status === 'initial') {
        statusElement.textContent = 'جارٍ الاتصال - عرض بيانات ذهب احتياطية';
        statusElement.className = 'connection-status initial';
      } else {
        statusElement.textContent = 'غير متصل - جارٍ إعادة الاتصال';
        statusElement.className = 'connection-status disconnected';
      }
    }

    // تحديث وقت آخر تحديث
    function updateLastUpdateTime(customDate) {
      if (customDate) {
        document.getElementById('last-update-time').textContent = customDate;
      } else {
        const now = new Date();
        const dateString = now.toLocaleDateString('ar-EG');
        const timeString = now.toLocaleTimeString('ar-EG');
        document.getElementById('last-update-time').textContent = `${dateString} - ${timeString}`;
      }
    }
  </script>
</body>
</html>

